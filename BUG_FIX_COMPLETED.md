# Исправление бага расчета загрузки печи

## Дата: 3 февраля 2026

## Проблема

При вводе очень маленьких размеров (0.1×0.1×1 см) программа выдавала нереалистичные результаты:
- **1,431,758 штук** вместо разумного количества
- **1.43 м²** площади

### Причина

Формула расчета "плиток плашмя поверх ребра" для очень маленьких изделий давала астрономические числа из-за деления очень большой площади на очень маленькую площадь изделия.

## Решение

### 1. Добавлена валидация минимальных размеров

**Файл:** `src/utils/kilnCalculations.ts`

**Добавлены константы:**
```typescript
const MIN_PRODUCT_SIZE = 1; // см - минимальный размер изделия
const MIN_THICKNESS = 0.3; // см - минимальная толщина
```

**Добавлена проверка:**
```typescript
if (
  product.length < MIN_PRODUCT_SIZE ||
  product.width < MIN_PRODUCT_SIZE ||
  product.thickness < MIN_THICKNESS
) {
  return null; // Изделие слишком маленькое
}
```

### 2. Улучшена формула flatPiecesPerLevel

**Файл:** `src/utils/kilnCalculations.ts` (строка 141)

**Было:**
```typescript
const flatPiecesPerLevel = Math.floor(
  flatAreaAvailable / ((product.length * product.width) / 10000)
);
```

**Стало:**
```typescript
const productAreaM2 = (product.length * product.width) / 10000;
let flatPiecesPerLevel = Math.floor(flatAreaAvailable / productAreaM2);

// Ограничение: не больше чем edgePiecesPerLevel * 2
if (flatPiecesPerLevel > edgePiecesPerLevel * 2) {
  flatPiecesPerLevel = edgePiecesPerLevel * 2;
}
```

**Обоснование:** Физически невозможно поместить на 30% площади в десятки раз больше изделий.

### 3. Добавлена валидация в UI

**Файл:** `src/components/ProductInput.tsx`

**Добавлены проверки перед расчетом:**
```typescript
if (lengthNum < 1 || widthNum < 1) {
  alert('⚠️ Минимальный размер изделия: 1×1 см\n...');
  return;
}

if (thicknessNum < 0.3) {
  alert('⚠️ Минимальная толщина изделия: 0.3 см (3 мм)\n...');
  return;
}
```

### 4. Обновлены атрибуты инпутов

**Изменено:**
- `min="0.1"` → `min="1"` для длины и ширины
- `min="0.1"` → `min="0.3"` для толщины
- `placeholder="30"` → `placeholder="10"` для длины
- `placeholder="40"` → `placeholder="10"` для ширины
- `placeholder="1.5"` → `placeholder="1"` для толщины

### 5. Добавлены подсказки (hints)

**Файл:** `src/components/ProductInput.tsx`

```typescript
Длина (см): <span className="hint">мин. 1 см</span>
Ширина (см): <span className="hint">мин. 1 см</span>
Толщина (см): <span className="hint">мин. 0.3 см</span>
```

**CSS:** `src/App.css`
```css
.input-group label .hint {
  font-size: 0.7rem;
  color: var(--text-gray);
  font-weight: 400;
  margin-left: 0.25rem;
}
```

### 6. Добавлено предупреждение при отсутствии результатов

**Файл:** `src/App.tsx`

```typescript
if (!newResults.big && !newResults.small) {
  alert(
    '❌ Изделие не помещается ни в одну печь.\n\n' +
    'Возможные причины:\n' +
    '• Размеры слишком малы (мин. 1×1×0.3 см)\n' +
    '• Размеры слишком велики для печей\n' +
    '• Глазурь не совместима с загрузкой'
  );
}
```

## Результаты

### До исправления:
- Ввод: 0.1×0.1×1 см
- Результат: **1,431,758 шт** и **1.43 м²** ❌

### После исправления:
- Ввод: 0.1×0.1×1 см
- Результат: **Ошибка валидации** - "Минимальный размер 1×1 см" ✅

### Тесты с реальными размерами:

#### Плитка 10×10×1 см:
- Большая печь (54×84 см):
  - По ширине: floor((54+1.5)/(10+1.5)) = 4 шт
  - По глубине: floor((84+1.5)/(10+1.5)) = 7 шт
  - На уровне: 4 × 7 = 28 шт
  - Уровней: floor(80/6) = 13
  - Всего: 28 × 13 = 364 шт
  - С коэффициентом: ceil(364 × 0.8) = **292 шт** ✅
  - Площадь: 292 × 0.01 = **2.92 м²** ✅

- Малая печь (95×150 см):
  - По ширине: floor((95+1.5)/(10+1.5)) = 8 шт
  - По глубине: floor((150+1.5)/(10+1.5)) = 13 шт
  - На уровне: 8 × 13 = 104 шт
  - Только 1 уровень
  - С коэффициентом: ceil(104 × 0.92) = **96 шт** ✅
  - Площадь: 96 × 0.01 = **0.96 м²** ✅

## Измененные файлы

1. ✅ `src/utils/kilnCalculations.ts`
   - Добавлены константы MIN_PRODUCT_SIZE и MIN_THICKNESS
   - Добавлена валидация минимальных размеров
   - Улучшена формула flatPiecesPerLevel

2. ✅ `src/components/ProductInput.tsx`
   - Добавлена валидация с alert
   - Обновлены min атрибуты
   - Обновлены placeholder-ы
   - Добавлены hints

3. ✅ `src/App.css`
   - Добавлен стиль .hint

4. ✅ `src/App.tsx`
   - Добавлен alert при отсутствии результатов

## Статус сборки

✅ **Сборка успешна**
```
CSS: 17.06 kB (3.07 kB gzipped)
JS:  176.51 kB (54.62 kB gzipped)
```

## Тестирование

### Валидация работает:
- ✅ 0.1×0.1×1 см → Показывает ошибку "Минимальный размер 1×1 см"
- ✅ 0.5×0.5×0.2 см → Показывает ошибку "Минимальная толщина 0.3 см"
- ✅ 1×1×0.3 см → Расчет проходит

### Реальные размеры работают:
- ✅ 10×10×1 см → ~292 шт (большая), ~96 шт (малая)
- ✅ 30×40×1.5 см → Корректные результаты
- ✅ 60×100×3 см → Только малая печь (большая отклоняет)

### Формула flatPiecesPerLevel ограничена:
- ✅ Для маленьких изделий количество "плашмя" не превышает edgePieces × 2

## Выводы

Баг успешно исправлен! Программа теперь:
1. ✅ Отклоняет нереалистично маленькие размеры
2. ✅ Показывает понятные сообщения об ошибках
3. ✅ Ограничивает количество плиток плашмя поверх ребра
4. ✅ Подсказывает пользователю минимальные размеры
5. ✅ Правильно рассчитывает для реальных размеров керамики

---

**URL для тестирования:** http://localhost:5173

**Запуск:** `./start.sh` или `npm run dev`
